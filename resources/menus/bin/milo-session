#!/bin/bash
# miloOS Session Manager
# Handles system power actions with confirmation dialogs

case "$1" in
    shutdown)
        if zenity --question --width=350 --height=120 \
            --title="Shut Down" \
            --text="<b>Are you sure you want to shut down your computer?</b>\n\nAll unsaved work will be lost." \
            --ok-label="Shut Down" \
            --cancel-label="Cancel" 2>/dev/null; then
            # Try multiple methods to ensure shutdown works
            systemctl poweroff || sudo poweroff || xfce4-session-logout --halt --fast
        fi
        ;;
    
    restart)
        if zenity --question --width=350 --height=120 \
            --title="Restart" \
            --text="<b>Are you sure you want to restart your computer?</b>\n\nAll unsaved work will be lost." \
            --ok-label="Restart" \
            --cancel-label="Cancel" 2>/dev/null; then
            # Try multiple methods to ensure restart works
            systemctl reboot || sudo reboot || xfce4-session-logout --reboot --fast
        fi
        ;;
    
    sleep|suspend)
        if zenity --question --width=350 --height=120 \
            --title="Suspend" \
            --text="<b>Suspend your computer?</b>\n\nYour work will be saved and you can resume later." \
            --ok-label="Suspend" \
            --cancel-label="Cancel" 2>/dev/null; then
            # Try multiple methods to ensure suspend works
            systemctl suspend || sudo pm-suspend || xfce4-session-logout --suspend
        fi
        ;;
    
    logout)
        if zenity --question --width=350 --height=120 \
            --title="Log Out" \
            --text="<b>Log out of your session?</b>\n\nAll applications will be closed." \
            --ok-label="Log Out" \
            --cancel-label="Cancel" 2>/dev/null; then
            # Logout from XFCE session
            xfce4-session-logout --logout --fast || pkill -KILL -u "$USER"
        fi
        ;;
    
    *)
        echo "Usage: $0 {shutdown|restart|sleep|logout}"
        exit 1
        ;;
esac

exit 0
